# Client Request Moderation System (Service-1 + Service-2)

Асинхронная система модерации клиентских запросов с использованием Kafka, Redis и PostgreSQL.  
Проект реализует событийно-ориентированную архитектуру, где Service-1 выступает оркестратором бизнес-логики модерации, а Service-2 отвечает за обогащение данных и кеширование приоритетов категорий.

---

## Архитектура

<img width="876" height="564" alt="Снимок экрана 2026-02-05 в 20 56 54" src="https://github.com/user-attachments/assets/1171962e-1d53-4853-8eb1-b68d3d03d68c" />

Компоненты:

1. Client — источник событий клиентских запросов  
2. Kafka Topic-1 — входящие события модерации  
3. Service-1 
   - принимает события из Kafka  
   - выполняет модерацию    
   - сохраняет запросы в PostgreSQL
   - запрашивает приоритет категории в Service-2
   - публикует результат в Kafka Topic-2  

4. Service-2 (Category Enrichment Service)  
   - хранит категории и их приоритеты в PostgreSQL  
   - кеширует категории в Redis  
   - предоставляет Service-1 данные о приоритетах  

5. Kafka Topic-2 — результаты модерации  

6. PostgreSQL  
   - хранение клиентских запросов  
   - хранение категорий (справочник)

7. Redis  
   - кеш категорий  
   - ускорение обработки запросов  

---

## Поток обработки запроса

### 1. Получение события

Service-1 получает событие из Kafka Topic-1:

```
clientId
eventId
category
createdAt
```

---

### 2. Обогащение данных

Service-1 отправляет запрос в Service-2 и получает:

```
category
priority
```

---

### 3. Применение бизнес-правил

Service-1:

- проверяет допустимость запроса  
- определяет статус модерации  
- сохраняет результат  

---

### 4. Публикация результата

Service-1 отправляет событие в Kafka Topic-2:

```
clientId
eventId
category
priority
createdAt
```

---

## Запуск проекта

### 1. Предварительные требования

Docker

---

### 2. Переменные окружения

Создать `.env` файл в корне проекта по образцу:

```
POSTGRES_DB
POSTGRES_USER
POSTGRES_PASSWORD

SPRING_DATASOURCE_URL
SPRING_DATASOURCE_USERNAME
SPRING_DATASOURCE_PASSWORD
```

---

### 3. Сборка и запуск

Из корня проекта выполнить команду:

```
docker compose up --build
```

После запуска будут подняты:

- PostgreSQL  
- Kafka  
- Redis  
- Service-1  
- Service-2  
- Kafka UI  

---

## Kafka Topics

### Topic-1
Входящие события модерации.

### Topic-2
Результаты обработки модерации.

---

## Пример входящего события (Topic-1)

```json
{
  "clientId": "client-001",
  "eventId": "event-001",
  "category": "PAYMENT",
  "createdAt": "2026-02-05T20:20:00Z"
}
```

---

## Используемые технологии

- Spring Boot  
- Spring Kafka  
- PostgreSQL  
- Redis  
- Docker  
- Kafka  

---

## Особенности реализации

### Идемпотентность

Service-1 предотвращает повторную обработку событий по `eventId`.

---

### Кеширование

Service-2 кеширует категории в Redis для ускорения обработки.

---

### Асинхронная обработка

Kafka обеспечивает устойчивость системы и высокую производительность.

---

## Нагрузочное тестирование

Нагрузочное тестирование используется для проверки устойчивости и производительности системы при обработке потока событий через Kafka. Для генерации нагрузки используется внешний Kafka producer (Node.js), который публикует события в Kafka Topic-1.

---

### Предварительные требования

- Docker
- Node.js (v18+)
- Запущенный проект (Service-1, Service-2, Kafka)

---

### Подготовка Kafka

Kafka сконфигурирована с двумя listener’ами:

- `kafka:9092` — для сервисов внутри Docker
- `localhost:29092` — для нагрузочного генератора, запускаемого с хоста

---

### Запуск нагрузочного тестирования

#### 1. Запустить систему

Из корня проекта:

```bash
docker compose up -d
```

Убедиться, что все контейнеры находятся в состоянии `running`.

#### 2. Перейти в директорию нагрузочного генератора

`cd kafka-load-js`

#### 3. Установить зависимости

`npm install`

#### 4. Запустить генерацию нагрузки

`node load.js`
